# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
name: Java Jar To Zip Publish
run-name: "[${{ (github.event_name == 'push' || ((inputs.push_to_registry || inputs.push_to_github_release) == true)) && 'æ­£å¼ç‰ˆ' || 'æµ‹è¯•ç‰ˆ' }}] ${{ github.event.repository.name }} ${{ github.event.inputs.tag_name || github.ref_name || 'v-manual' }}  version"

on:
  push:
    branches:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'è¾“å…¥ Release æ ‡ç­¾ (eg: v0.35.1, v0.36.5-alpha.1)'
        required: false
        type: string
        default: 'v-manual'
      skip_tests:
        description: 'æ˜¯å¦è·³è¿‡æµ‹è¯• (true/false)'
        required: true
        type: boolean
        default: false
      java_version:
        description: 'è¾“å…¥ Java ç‰ˆæœ¬ (å¦‚ 8, 11, 17)'
        required: true
        default: '8'
      jar_dir_prefix:
        description: 'JAR æ–‡ä»¶å‰ç¼€ (å¦‚ bgi-tools æˆ–ç•™ç©º)'
        default: ''
      draft:
        description: 'æ˜¯å¦ä¸ºè‰ç¨¿ Release (true/false)'
        type: boolean
        default: false
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒ Release (true/false)'
        type: boolean
        default: false
      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°é•œåƒä»“åº“'
        required: true
        type: boolean
        default: true
      push_to_github_release:
        description: 'æ˜¯å¦æ¨é€åˆ°Github Release'
        required: true
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    # å®šä¹‰ outputs ä»¥ä¾¿åç»­ job ä½¿ç”¨
    outputs:
      tag_name: ${{ steps.set_vars.outputs.tag_name }}
      java_version: ${{ steps.set_vars.outputs.java_version }}
      jar_dir_prefix: ${{ steps.set_vars.outputs.jar_dir_prefix }}
      push_to_registry: ${{ steps.set_vars.outputs.push_to_registry }}
      push_to_github_release: ${{ steps.set_vars.outputs.push_to_github_release }}
    permissions:
      contents: write
      #releases: write
      actions: read
    steps:
      - name: 1.è°ƒè¯•è§¦å‘ä¿¡æ¯
        run: |
          echo "Event Name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Tag Name: ${{ github.event.inputs.tag_name || github.ref_name }}"
          echo "Skip Tests: ${{ github.event.inputs.skip_tests || true }}"
          echo "Java Version: ${{ github.event.inputs.java_version ||secrets.JAVA_VERSION|| '8' }}"
          echo "Jar Dir Prefix: ${{ github.event.inputs.jar_dir_prefix || 'bgi-tools' }}"
          echo "Draft: ${{ github.event.inputs.draft || false }}"
          echo "Prerelease: ${{ github.event.inputs.prerelease || false }}"
          echo "Repository: ${{ github.repository }}"
          echo "SHA: ${{ github.sha }}"

      - name: 2.æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 3.è®¾ç½®è¾“å…¥å€¼
        id: set_vars
        run: |
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆå§‹åŒ–é»˜è®¤å€¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          TAG_NAME="${{ github.event.inputs.tag_name || github.ref_name || 'v-manual' }}"

          # å¤„ç†å¸ƒå°”å€¼æ—¶è¦å°å¿ƒï¼šworkflow_dispatch çš„ inputs æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦è½¬æ¢
          SKIP_TESTS="${{ inputs.skip_tests || 'false' }}"   # å…ˆå–è¾“å…¥ï¼Œé»˜è®¤ falseï¼ˆå­—ç¬¦ä¸²ï¼‰
          if [[ "$SKIP_TESTS" == "true" || "$SKIP_TESTS" == "1" ]]; then
            SKIP_TESTS=true
          else
            SKIP_TESTS=false
          fi

          JAVA_VERSION="${{ inputs.java_version || secrets.JAVA_VERSION || '8' }}"
          JAR_DIR_PREFIX="${{ inputs.jar_dir_prefix || 'bgi-tools' }}"
          DRAFT="${{ inputs.draft || 'false' }}"
          PRERELEASE="${{ inputs.prerelease || 'false' }}"

          # å…ˆå‡è®¾ä¸æ˜¯è‡ªåŠ¨è§¦å‘
          AUTO=false
          PUSH_TO_REGISTRY=false
          PUSH_TO_GITHUB_RELEASE=false

          # åˆ¤æ–­æ˜¯å¦è‡ªåŠ¨è§¦å‘ï¼ˆtag ä»¥ v å¼€å¤´ï¼‰
          if [[ "$TAG_NAME" == v* ]]; then
            AUTO=true
            PUSH_TO_REGISTRY=true
            PUSH_TO_GITHUB_RELEASE=true
          else
            # æ‰‹åŠ¨è§¦å‘æ—¶æ‰å°Šé‡ç”¨æˆ·è¾“å…¥
            if [[ "${{ github.event_name }}" == "push" ]]; then
              PUSH_TO_REGISTRY=true
              PUSH_TO_GITHUB_RELEASE=true
            else
              # workflow_dispatch æ—¶ç”¨ç”¨æˆ·è¾“å…¥ï¼ˆå­—ç¬¦ä¸²è½¬å¸ƒå°”ï¼‰
              if [[ "${{ inputs.push_to_registry }}" == "true" ]]; then
                PUSH_TO_REGISTRY=true
              fi
              if [[ "${{ inputs.push_to_github_release }}" == "true" ]]; then
                PUSH_TO_GITHUB_RELEASE=true
              fi
            fi
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å†™å…¥ç¯å¢ƒå˜é‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "AUTO=$AUTO" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "SKIP_TESTS=$SKIP_TESTS" >> $GITHUB_ENV
          echo "JAVA_VERSION=$JAVA_VERSION" >> $GITHUB_ENV
          echo "JAR_DIR_PREFIX=$JAR_DIR_PREFIX" >> $GITHUB_ENV
          echo "DRAFT=$DRAFT" >> $GITHUB_ENV
          echo "PRERELEASE=$PRERELEASE" >> $GITHUB_ENV
          echo "PUSH_TO_REGISTRY=$PUSH_TO_REGISTRY" >> $GITHUB_ENV
          echo "PUSH_TO_GITHUB_RELEASE=$PUSH_TO_GITHUB_RELEASE" >> $GITHUB_ENV
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ–°å¢ï¼šåªä¸º outputs è®¾ç½®å°å†™ç‰ˆæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "java_version=$JAVA_VERSION" >> $GITHUB_OUTPUT
          echo "jar_dir_prefix=$JAR_DIR_PREFIX" >> $GITHUB_OUTPUT
          echo "push_to_registry=$PUSH_TO_REGISTRY" >> $GITHUB_OUTPUT
          echo "push_to_github_release=$PUSH_TO_GITHUB_RELEASE" >> $GITHUB_OUTPUT

          # è°ƒè¯•è¾“å‡ºï¼ˆå¼ºçƒˆæ¨èä¿ç•™ï¼‰
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "æœ€ç»ˆè®¾ç½®å€¼ï¼š"
          echo "  AUTO                   : $AUTO"
          echo "  TAG_NAME               : $TAG_NAME"
          echo "  SKIP_TESTS             : $SKIP_TESTS"
          echo "  JAVA_VERSION           : $JAVA_VERSION"
          echo "  JAR_DIR_PREFIX         : $JAR_DIR_PREFIX"
          echo "  DRAFT                  : $DRAFT"
          echo "  PRERELEASE             : $PRERELEASE"
          echo "  PUSH_TO_REGISTRY       : $PUSH_TO_REGISTRY"
          echo "  PUSH_TO_GITHUB_RELEASE : $PUSH_TO_GITHUB_RELEASE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: 4.éªŒè¯ç‰ˆæœ¬å·
        run: |
          echo "å½“å‰ç‰ˆæœ¬å·: $TAG_NAME"
          if ! [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬æ ¼å¼å¿…é¡»ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒ (ä¾‹å¦‚: v1.2.3, v1.2.3-alpha, v1.2.3+build.123)"
            exit 1
          fi
          echo "ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"

      - name: 5.è®¾ç½® Java ç¯å¢ƒ version=${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: 6.ç¼“å­˜ Maven ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: 7.ä½¿ç”¨ Maven æ„å»ºå¹¶ç”Ÿæˆ JAR
        run: |
          if [ ${{ env.SKIP_TESTS }} ]; then
            echo "è·³è¿‡æµ‹è¯•"
            echo "mvn clean package -B -DskipTests -Dquickly"
            mvn clean package -B -DskipTests -Dquickly
          else
            echo "mvn clean package -B -Dquickly"
            mvn clean package -B -Dquickly
          fi
          echo "Maven æ„å»ºå®Œæˆ"
          echo "åŒ¹é…çš„ JAR æ–‡ä»¶ (*/target/*.jar):"
          find . -type f -path "*/target/*.jar"
          echo "åŒ¹é…çš„ JAR æ–‡ä»¶ (*/${{ env.JAR_DIR_PREFIX  }}/target/*.jar):"
          find . -type f -path "*/${{ env.JAR_DIR_PREFIX  }}/target/*.jar" || echo "æœªæ‰¾åˆ°åŒ¹é…çš„ JAR æ–‡ä»¶"

      - name: 8.åˆ—å‡ºåŒ¹é…çš„ JAR æ–‡ä»¶
        run: |
          if [ "${{ env.JAR_DIR_PREFIX  }}" = "" ]; then
            echo "åŒ¹é…çš„ JAR æ–‡ä»¶ (*/target/*.jar):"
            find . -type f -path "*/target/*.jar" || echo "æœªæ‰¾åˆ°åŒ¹é…çš„ JAR æ–‡ä»¶"
          else
            echo "åŒ¹é…çš„ JAR æ–‡ä»¶ (*/${{ env.JAR_DIR_PREFIX  }}/target/*.jar):"
            find . -type f -path "*/${{ env.JAR_DIR_PREFIX  }}/target/*.jar" || echo "æœªæ‰¾åˆ°åŒ¹é…çš„ JAR æ–‡ä»¶"
            echo "åŒ¹é…çš„ JAR æ–‡ä»¶ (*/${{ env.JAR_DIR_PREFIX  }}/*/target/*.jar):"
            find . -type f -path "*/${{ env.JAR_DIR_PREFIX  }}/*/target/*.jar" || echo "æœªæ‰¾åˆ°åŒ¹é…çš„ JAR æ–‡ä»¶"  
          fi

      - name: 9.æ‰“åŒ…æ‰€æœ‰ JAR æ–‡ä»¶æˆ ZIP
        run: |
          if [ "${{ env.JAR_DIR_PREFIX }}" = "" ]; then
            find . -type f -path "*/target/*.jar" -exec zip -j jars-${{ env.TAG_NAME }}.zip {} +
          else
            find . -type f \( -path "*/${{ env.JAR_DIR_PREFIX }}/target/*.jar" -o -path "*/${{ env.JAR_DIR_PREFIX }}/*/target/*.jar" \) -print0 | xargs -0 -I {} zip -j "jars-${{ env.TAG_NAME }}.zip" {}
          fi
          # -j: ä»…æ‰“åŒ…æ–‡ä»¶ï¼Œä¸ä¿ç•™ç›®å½•ç»“æ„
          # +: å°½é‡å°†å¤šä¸ªæ–‡ä»¶æ”¾å…¥ä¸€ä¸ª zip å‘½ä»¤ï¼Œå‡å°‘è°ƒç”¨æ¬¡æ•°
        shell: bash

      - name: 10.éªŒè¯ ZIP æ–‡ä»¶
        run: |
          ls -la jars-${{ env.TAG_NAME}}.zip
          echo "ZIP æ–‡ä»¶å†…å®¹:"
          unzip -l jars-${{ env.TAG_NAME }}.zip

      - name: 11.è§£å‹ ZIP æ–‡ä»¶
        run: |
          mkdir -p extracted-jars
          unzip jars-${{ env.TAG_NAME }}.zip -d extracted-jars
          echo "è§£å‹åçš„æ–‡ä»¶:"
          ls -la extracted-jars

      - name: 12. å°† JAR æ–‡ä»¶è½¬æ¢ä¸ºç‹¬ç«‹ EXEï¼ˆæ†ç»‘ç§æœ‰ JREï¼Œå®Œå…¨ç‹¬ç«‹è¿è¡Œï¼‰
        run: |
          # ============ ä¸‹è½½ Launch4j ============
          wget --tries=5 --timeout=60 \
            https://pilotfiber.dl.sourceforge.net/project/launch4j/launch4j-3/3.50/launch4j-3.50-linux-x64.tgz?viasf=1 \
            -O /tmp/launch4j.tgz || \
          wget --tries=5 \
            https://sourceforge.net/projects/launch4j/files/launch4j-3/3.50/launch4j-3.50-linux-x64.tgz/download \
            -O /tmp/launch4j.tgz

          tar -xzf /tmp/launch4j.tgz -C /tmp

          sudo apt-get update
          sudo apt-get install -y mingw-w64 g++-mingw-w64-i686 gcc-mingw-w64-i686 binutils-mingw-w64-i686

          ln -sf /usr/bin/i686-w64-mingw32-windres /tmp/launch4j/bin/windres
          ln -sf /usr/bin/i686-w64-mingw32-ld /tmp/launch4j/bin/ld

          # ============ ä¸‹è½½å¹¶æ†ç»‘ç§æœ‰ JREï¼ˆå®‰å…¨æå– jre å­ç›®å½•ï¼‰ ============
          echo "ğŸ“¦ æ­£åœ¨ä¸‹è½½ Adoptium Temurin Java 8 æœ€æ–° JDK (Windows x64ï¼Œç”¨äºæå– jRE)"

          sudo apt-get install -y jq  # ç”¨äº API è§£æ

          API_URL="https://api.adoptium.net/v3/assets/latest/${{ env.JAVA_VERSION }}/hotspot?image_type=jdk&os=windows&arch=x64&vendor=adoptium"

          DOWNLOAD_URL=$(curl -s "$API_URL" | jq -r '.[0].binary.package.link')

          #if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
          #  echo "âš ï¸ API æœªè¿”å›é“¾æ¥ï¼Œä½¿ç”¨å…œåº•ç‰ˆæœ¬ï¼ˆ2026å¹´1æœˆæœ€æ–° jdk8u482-b07ï¼‰"
          #  DOWNLOAD_URL="https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u482-b07/OpenJDK8U-jdk_x64_windows_hotspot_8u482b07.zip"
          #fi

          echo "âœ… ä¸‹è½½é“¾æ¥: $DOWNLOAD_URL"
          wget -q "$DOWNLOAD_URL" -O /tmp/jdk.zip

          # ç”Ÿæˆéšæœºä¸´æ—¶ç›®å½•è§£å‹ï¼Œé¿å… /tmp æ±¡æŸ“
          TEMP_EXTRACT_DIR=$(mktemp -d /tmp/jdk_extract_XXXXXX)
          echo "ğŸ—‚ï¸ è§£å‹åˆ°ä¸´æ—¶ç›®å½•: $TEMP_EXTRACT_DIR"

          unzip -q /tmp/jdk.zip -d "$TEMP_EXTRACT_DIR"

          # æ‰¾åˆ°è§£å‹åçš„å”¯ä¸€æ ¹ç›®å½•ï¼ˆJDK åŒ…æ€»æ˜¯åªæœ‰ä¸€ä¸ªå­ç›®å½•ï¼‰
          JDK_ROOT_DIR=$(find "$TEMP_EXTRACT_DIR" -mindepth 1 -maxdepth 1 -type d | head -1)

          if [ -z "$JDK_ROOT_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ° JDK æ ¹ç›®å½•"
            ls -la "$TEMP_EXTRACT_DIR"
            exit 1
          fi

          # æ‰¾åˆ° jre å­ç›®å½•ï¼ˆJava 8 å›ºå®šå« jreï¼‰
          JRE_SOURCE_DIR="$JDK_ROOT_DIR/jre"

          if [ ! -d "$JRE_SOURCE_DIR" ]; then
            echo "âŒ JDK æ ¹ç›®å½•ä¸‹æœªæ‰¾åˆ° jre å­ç›®å½•ï¼ˆç»“æ„å¼‚å¸¸ï¼‰"
            ls -la "$JDK_ROOT_DIR"
            exit 1
          fi

          # ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®ï¼Œé‡å‘½åä¸ºæ ‡å‡† jre
          mkdir -p extracted-jars
          mv "$JRE_SOURCE_DIR" extracted-jars/jre

          echo "âœ… ç§æœ‰ JRE å·²æˆåŠŸæå–å¹¶æ†ç»‘åˆ° extracted-jars/jre/ ï¼ˆå¤§å°: $(du -sh extracted-jars/jre | cut -f1)ï¼‰"

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "$TEMP_EXTRACT_DIR" /tmp/jdk.zip

          # ============ ç‰ˆæœ¬å¤„ç† ============
          RAW_TAG=${TAG_NAME#v}
          RAW_TAG=${RAW_TAG:-0.0.1}
          CLEAN_VERSION=$(echo "$RAW_TAG" | sed 's/[^0-9.]//g' | sed 's/^\.*//; s/\.*$//; s/\.\.+/\./g')
          CLEAN_VERSION=${CLEAN_VERSION:-0.0.1}

          IFS='.' read -r -a parts <<< "$CLEAN_VERSION"
          major=${parts[0]:-0} minor=${parts[1]:-0} patch=${parts[2]:-0} build=${parts[3]:-0}
          FILE_VERSION="$major.$minor.$patch.$build"
          TXT_VERSION="${TAG_NAME:-v$major.$minor.$patch}"
          echo "ğŸ› ï¸ ç‰ˆæœ¬: FileVersion=$FILE_VERSION, TxtVersion=$TXT_VERSION"

          # ============ ç”Ÿæˆç‹¬ç«‹ EXE ============
          mkdir -p extracted-jars

          for jar_file in extracted-jars/*.jar; do
            [ -f "$jar_file" ] || { echo "âŒ æœªæ‰¾åˆ° JAR æ–‡ä»¶"; exit 1; }
            jar_name=$(basename "$jar_file" .jar)
            exe_file="extracted-jars/${jar_name}.exe"

            abs_jar=$(realpath "$jar_file")
            abs_exe=$(realpath -m "$exe_file")

            main_class=$(unzip -p "$jar_file" META-INF/MANIFEST.MF | grep '^Main-Class:' | sed 's/^Main-Class: *//' | tr -d '\r')
            [ -z "$main_class" ] && echo "âš ï¸ $jar_file æ—  Main-Classï¼Œè·³è¿‡" && continue

            config_file="/tmp/launch4j_${jar_name}_config.xml"
            cat > "$config_file" << EOF
          <launch4jConfig>
            <dontWrapJar>false</dontWrapJar>
            <headerType>console</headerType>
            <jar>$abs_jar</jar>
            <outfile>$abs_exe</outfile>
            <errTitle>${{ github.event.repository.name }} Error</errTitle>
            <classPath>
              <mainClass>$main_class</mainClass>
            </classPath>
            <jre>
              <path>jre</path>                               <!-- å…³é”®ï¼šä½¿ç”¨åŒç›®å½•çš„ jre æ–‡ä»¶å¤¹ -->
              <minVersion>${{ env.JAVA_VERSION }}.0</minVersion>
              <maxVersion>${{ env.JAVA_VERSION }}.999</maxVersion>
              <requiresJdk>false</requiresJdk>
              <jdkPreference>preferBundled</jdkPreference>    <!-- ä¼˜å…ˆä½¿ç”¨æ†ç»‘çš„ JRE -->
            </jre>
            <versionInfo>
              <fileVersion>$FILE_VERSION</fileVersion>
              <txtFileVersion>$TXT_VERSION</txtFileVersion>
              <productVersion>$FILE_VERSION</productVersion>
              <txtProductVersion>$TXT_VERSION</txtProductVersion>
              <fileDescription>${{ github.event.repository.name }} Standalone (Java ${{ env.JAVA_VERSION }})</fileDescription>
              <copyright>Copyright (c) 2023-2026</copyright>
              <productName>${{ github.event.repository.name }}</productName>
              <internalName>${jar_name}</internalName>
              <originalFilename>${jar_name}.exe</originalFilename>
            </versionInfo>
          </launch4jConfig>
          EOF

            echo "âœ… æ­£åœ¨ç”Ÿæˆå®Œå…¨ç‹¬ç«‹ EXE: $exe_file (å¸¦ç§æœ‰ JRE)"
            java -Djava.awt.headless=true -jar /tmp/launch4j/launch4j.jar "$config_file"

            if [ -f "$exe_file" ]; then
              echo "ğŸ‰ğŸ‰ğŸ‰ æˆåŠŸç”Ÿæˆç‹¬ç«‹è¿è¡Œ EXE: $exe_file (å¤§å°: $(du -h "$exe_file" | cut -f1))"
            else
              echo "âŒ ç”Ÿæˆå¤±è´¥"
              cat /tmp/launch4j/launch4j.log 2>/dev/null || true
            fi
          done

          echo "=== æœ€ç»ˆæ‰“åŒ…ç›®å½•å†…å®¹ ==="
          ls -lh extracted-jars/
          du -sh extracted-jars/jre extracted-jars/*.exe

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/launch4j /tmp/launch4j.tgz /tmp/jre.zip /tmp/jdk-* /tmp/launch4j_*_config.xml
        shell: bash

      - name: 13. æ‰“åŒ…ä»…å« EXE + JRE + é…ç½®æ–‡ä»¶çš„ç‹¬ç«‹è¿è¡ŒåŒ…
        run: |
          # åˆ›å»ºä¸´æ—¶æ‰“åŒ…ç›®å½•
          mkdir -p standalone-package

          # å¤åˆ¶ EXE å’Œ jre æ–‡ä»¶å¤¹
          cp extracted-jars/*.exe standalone-package/ 2>/dev/null || echo "æ—  EXE"
          cp -r extracted-jars/jre standalone-package/ 2>/dev/null || echo "æ—  jre"

          # å…³é”®ï¼šå¤åˆ¶ application-prod.yml åˆ°æ‰“åŒ…ç›®å½•ï¼ˆä¸ EXE åŒçº§ï¼‰
          if [ -f src/main/resources/application-prod.yml ]; then
            cp src/main/resources/application-prod.yml standalone-package/
            echo "âœ… å·²åŒ…å« application-prod.yml é…ç½®æ–‡ä»¶"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° src/main/resources/application-prod.ymlï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿åˆ›å»º"
            cat > standalone-package/application-prod.yml << 'EOF'
          server:
            port: 8081
            servlet:
              context-path: /bgi
          
          ws:
            url: ws://localhost:8081/ws # å¯å¿½ç•¥ï¼Œç¨‹åºå†…éƒ¨è‡ªåŠ¨è®¡ç®—
            access-token-name: access-token
          EOF
          fi
          
          # æ‰“æˆ ZIP
          cd standalone-package
          zip -r ../${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip ./*
          cd ..
          
          echo "âœ… ç‹¬ç«‹è¿è¡ŒåŒ…æ‰“åŒ…å®Œæˆï¼ˆåŒ…å« EXE + jre + application-prod.ymlï¼‰"
          ls -lh ${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip
          du -sh ${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip     

      - name: 14. ä¸Šä¼ åˆ° GitHub Releaseï¼ˆåŒ…å«ç‹¬ç«‹ EXE åŒ…ï¼‰
        uses: softprops/action-gh-release@v2
        if: ${{ needs.build-and-release.outputs.push_to_github_release == 'true' }}
        #if: ${{ github.event_name == 'push' || inputs.push_to_github_release == true }}
        with:
          name: ${{ env.TAG_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          files: |
            jars-${{ env.TAG_NAME }}.zip
            extracted-jars/*.jar
            extracted-jars/*.exe
            ${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip
          body: |
            **Release ä¿¡æ¯**
            - æ ‡ç­¾: ${{ env.TAG_NAME }}
            - Java ç‰ˆæœ¬: ${{ env.JAVA_VERSION}}
            **${{ github.event.repository.name }} ${{ env.TAG_NAME }} å‘å¸ƒ**

            ### ğŸ† æ¨èä¸‹è½½ï¼ˆå®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€å®‰è£… Javaï¼‰
            - **${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip**  
              â†’ è§£å‹åç›´æ¥åŒå‡» `.exe` æ–‡ä»¶è¿è¡Œï¼ˆå·²å†…ç½® Java è¿è¡Œæ—¶ï¼‰

            ### ğŸ“¦ å…¶ä»–æ–‡ä»¶
            - `jars-${{ env.TAG_NAME }}.zip`ï¼šåŸå§‹ JAR åŒ…
            - å•ä¸ª `.jar` æ–‡ä»¶ï¼šä¾›å¼€å‘è€…ä½¿ç”¨
            - å•ä¸ª `.exe` æ–‡ä»¶ï¼šä»… EXEï¼ˆéœ€ç³»ç»Ÿå·²å®‰è£… Java ${{ env.JAVA_VERSION}}ï¼‰

            **ç³»ç»Ÿè¦æ±‚**ï¼šWindows 10/11 x64  
            **è¿è¡Œæ–¹å¼**ï¼šæ¨èä½¿ç”¨ç‹¬ç«‹åŒ…ï¼ŒåŒå‡»å³è·‘

            å¦‚æœ‰é—®é¢˜æ¬¢è¿åé¦ˆï¼
          draft: ${{ env.DRAFT == true || false }}
          prerelease: ${{ env.PRERELEASE == true || false }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

      # åœ¨æ­¥éª¤ ä¹‹åæ·»åŠ æ–°çš„ artifact ä¸Šä¼ æ­¥éª¤
      - name: Upload JAR files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-files
          path: extracted-jars/*.jar

      - name: ä¸Šä¼ ç‹¬ç«‹ EXE åŒ…ä½œä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-Windows-Standalone
          path: ${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip

  build-and-push:
    runs-on: ubuntu-latest
    needs: build-and-release  # æ·»åŠ ä¾èµ–å…³ç³»
    permissions:
      contents: read
      packages: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ä¸‹è½½ä¹‹å‰å·¥ä½œæµçš„æ„å»ºäº§ç‰©
      - name: Download JAR artifacts
        uses: actions/download-artifact@v4
        with:
          name: jar-files
          path: ./

      - name: List downloaded files
        run: ls -la ./

      - name: é…ç½®
        run: |
          DOCKER_FILE_NAME="Dockerfile"
          if [ -f "$DOCKER_FILE_NAME" ]; then
              echo "$DOCKER_FILE_NAME already exists"
              cat "$DOCKER_FILE_NAME"
          else
              cat > "$DOCKER_FILE_NAME" << EOF
              FROM eclipse-temurin:${{ needs.build-and-release.outputs.java_version }}-jre-alpine
              VOLUME /tmp
              COPY *.jar /app/app.jar
              ENTRYPOINT ["java","-jar","/app/app.jar"]
          EOF
              if [ -f "$DOCKER_FILE_NAME" ]; then
                echo "$DOCKER_FILE_NAME created successfully"
                cat "$DOCKER_FILE_NAME"
              else
              echo "Error: $DOCKER_FILE_NAME creation failed"
              exit 1
              fi
          fi          
          
          echo "DOCKER_FILE_NAME=$DOCKER_FILE_NAME" >> $GITHUB_ENV

      # è®¾ç½® Docker Buildx
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v2

      # ç™»å½•åˆ° GitHub Container Registry
      - name: ç™»å½• Log in to Container Registry
        if: ${{ needs.build-and-release.outputs.push_to_registry == 'true' }}
        #if: ${{ github.event_name == 'push' || inputs.push_to_registry == true }}
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æå– Docker é•œåƒå…ƒæ•°æ®
      - name: æå– Docker é•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ github.ref_name }}
            type=raw,value=latest
      

      # æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: æ„å»ºå¹¶æ¨é€ Docker image
        uses: docker/build-push-action@v4
        #if: ${{ needs.build-and-release.outputs.push_to_registry == 'true' }}
        #if: ${{ github.event_name == 'push' || inputs.push_to_registry == true }}
        with:
          context: .
          file: ./${{ env.DOCKER_FILE_NAME}}
          push: ${{ needs.build-and-release.outputs.push_to_registry == 'true' }}
          #push: ${{ github.event_name == 'push' || inputs.push_to_registry == true }}
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            JAVA_VERSION=${{needs.build-and-release.outputs.java_version}}
            JAR_FILE_PATH=./*.jar

      # éªŒè¯æ„å»ºçš„é•œåƒ
      - name: éªŒè¯æ„å»º Docker image
        run: |
          docker images
          #if [ "${{ github.event_name == 'push' || inputs.push_to_registry == true }}" ]; then
          if [ "${{ needs.build-and-release.outputs.push_to_registry == 'true' }}" ]; then
            echo "Docker image pushed successfully"
          else
            echo "Docker image built locally only"
          fi
      

      # ============ æ–°å¢ï¼šä¿å­˜å¹¶ä¸Šä¼  Docker é•œåƒ ============
      - name: ä¿å­˜ Docker é•œåƒä¸º tar æ–‡ä»¶
        run: |
          # å–å¾—ç¬¬ä¸€ä¸ª tagï¼ˆé€šå¸¸æ˜¯æœ€ä¸»è¦çš„é‚£ä¸ªï¼‰
          IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n 1)
          echo "æ­£åœ¨ä¿å­˜çš„é•œåƒæ ‡ç­¾: $IMAGE_TAG"

          # ä½¿ç”¨æœ€å®‰å…¨çš„æ–‡ä»¶åç­–ç•¥ï¼šç‰ˆæœ¬å· + æ—¶é—´æˆ³
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAR_FILE_NAME="docker-${{ needs.build-and-release.outputs.tag_name }}-${TIMESTAMP}.tar"

          echo "æœ€ç»ˆå®‰å…¨æ–‡ä»¶å: $TAR_FILE_NAME"

          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          if ! docker image inspect "$IMAGE_TAG" >/dev/null 2>&1; then
            echo "âŒ é•œåƒ $IMAGE_TAG ä¸å­˜åœ¨ï¼å½“å‰æœ¬åœ°é•œåƒåˆ—è¡¨ï¼š"
            docker images
            exit 1
          fi

          # ä¿å­˜é•œåƒ
          docker save "$IMAGE_TAG" -o "$TAR_FILE_NAME"

          # è®°å½•ç»™ä¸‹ä¸€æ­¥ä½¿ç”¨
          echo "TAR_FILE_NAME=$TAR_FILE_NAME" >> $GITHUB_ENV

      # åˆ›å»ºä½¿ç”¨è¯´æ˜ Markdown æ–‡ä»¶
      - name: åˆ›å»º Docker ä½¿ç”¨è¯´æ˜æ–‡æ¡£ (README-Docker-Usage.md)
        run: |
          cat <<EOF > README-Docker-Usage.md
          # ${{ github.event.repository.name }} Docker é•œåƒä½¿ç”¨è¯´æ˜

          **å½“å‰é•œåƒç‰ˆæœ¬**ï¼š${{ needs.build-and-release.outputs.tag_name}}  
          **æ„å»ºæ—¶é—´**ï¼š$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S') (HKT)  
          **é•œåƒæ ‡ç­¾ç¤ºä¾‹**ï¼šghcr.io/${{ github.repository }}:${{ needs.build-and-release.outputs.tag_name }} æˆ– :latest

          è¿™æ˜¯ä¸€ä¸ª**å®Œæ•´çš„ Docker é•œåƒå¯¼å‡ºåŒ…**ï¼ˆ.tar æ–‡ä»¶ï¼‰ï¼ŒåŒ…å« ${{ github.event.repository.name }} åº”ç”¨åŠè¿è¡Œç¯å¢ƒã€‚  
          æ”¯æŒå®Œå…¨ç¦»çº¿éƒ¨ç½²ï¼Œæ— éœ€è”ç½‘æ‹‰å–é•œåƒï¼Œéå¸¸é€‚åˆå†…ç½‘æœåŠ¡å™¨ã€æµ‹è¯•æœºæˆ–å¿«é€Ÿåˆ†å‘ã€‚

          ## 1. å¯¼å…¥é•œåƒ

          åœ¨ä»»ä½•å®‰è£…äº† Docker çš„æœºå™¨ä¸Šï¼Œç›´æ¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

          \`\`\`bash
          # ä½¿ç”¨ workflow ç”Ÿæˆçš„ç²¾ç¡®æ–‡ä»¶åå¯¼å…¥é•œåƒ
          docker load -i $TAR_FILE_NAME

          # æˆåŠŸåä¼šæ˜¾ç¤ºç±»ä¼¼ï¼š
          # Loaded image: ghcr.io/${{ github.repository }}:${{ needs.build-and-release.outputs.tag_name }}
          # Loaded image: ghcr.io/${{ github.repository }}:latest
          \`\`\`

          \`\`\`bash
          # æŸ¥çœ‹å·²å¯¼å…¥çš„é•œåƒ
          docker images | grep ${{ github.event.repository.name }}
          \`\`\`

          ## 2. å¯åŠ¨å®¹å™¨ï¼ˆæ¨èæ–¹å¼ï¼‰

          \`\`\`bash
          docker run -d \\
            --name ${{ github.event.repository.name }}\\
            -p 8081:8081 \\
            -v \$(pwd)/${{ github.event.repository.name }}:/app \\           # å¯é€‰ï¼šæŒ‚è½½é…ç½®æ–‡ä»¶ç›®å½•
            --restart unless-stopped \\
            ghcr.io/${{ github.repository }}:${{needs.build-and-release.outputs.tag_name }}
          \`\`\`

          - **é»˜è®¤ç«¯å£**ï¼š8081ï¼ˆå¯åœ¨ application-prod.yml ä¸­ä¿®æ”¹ï¼‰  
          - **è®¿é—®åœ°å€**ï¼šhttp://ä½ çš„æœåŠ¡å™¨IP:8081/bgi  
          - **é…ç½®æ–‡ä»¶æŒ‚è½½å»ºè®®**ï¼š  
            åœ¨å½“å‰ç›®å½•åˆ›å»º config æ–‡ä»¶å¤¹ï¼Œå°† application-prod.yml æ”¾å…¥å…¶ä¸­

          ## 3. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

          \`\`\`bash
          # æŸ¥çœ‹å®æ—¶æ—¥å¿—
          docker logs -f ${{ github.event.repository.name }}

          # è¿›å…¥å®¹å™¨å†…éƒ¨ï¼ˆè°ƒè¯•ç”¨ï¼‰
          docker exec -it ${{ github.event.repository.name }} /bin/sh

          # åœæ­¢å¹¶åˆ é™¤å®¹å™¨
          docker stop ${{ github.event.repository.name }} && docker rm ${{ github.event.repository.name }}
          \`\`\`

          ## 4. æ³¨æ„äº‹é¡¹

          - éœ€è¦ Docker 20.10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - å½“å‰é•œåƒå¹³å°ï¼šlinux/amd64ï¼ˆé€‚ç”¨äºå¤§å¤šæ•°æœåŠ¡å™¨å’Œ PCï¼‰
          - å¦‚é‡ç«¯å£å†²çªã€ç½‘ç»œé—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
            - é˜²ç«å¢™è®¾ç½®
            - ç«¯å£æ˜ å°„æ˜¯å¦æ­£ç¡®
            - æ˜¯å¦æœ‰å…¶ä»–ç¨‹åºå ç”¨ 8081 ç«¯å£
          - é—®é¢˜åé¦ˆï¼šæ¬¢è¿åœ¨ GitHub Issues ç•™è¨€

          **ç¥ä½¿ç”¨æ„‰å¿«ï¼**  
          æ–‡æ¡£ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆäºæ„å»º ${{ github.run_id }}
          EOF

          # è°ƒè¯•è¾“å‡ºï¼šç¡®è®¤æ–‡ä»¶åå·²æ­£ç¡®å±•å¼€
          echo "ä½¿ç”¨çš„ TAR_FILE_NAME å€¼ï¼š$TAR_FILE_NAME"
          echo "ç”Ÿæˆçš„ Markdown æ–‡ä»¶å†…å®¹é¢„è§ˆï¼š"
          cat README-Docker-Usage.md      

      - name: ä¸Šä¼  Docker é•œåƒ tar æ–‡ä»¶ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-artifact
          path: |
            ${{ env.TAR_FILE_NAME }}
            README-Docker-Usage.md
          # retention-days: 5 # è®¾ç½®ä¿ç•™å¤©æ•°ä¸º5å¤©