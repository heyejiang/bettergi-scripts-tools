# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
name: Java Jar To Zip Publish
run-name: "[${{ (github.event_name == 'push' || ((inputs.push_to_docker_registry || inputs.push_to_github_release) == true)) && 'æ­£å¼ç‰ˆ' || 'æµ‹è¯•ç‰ˆ' }}] ${{ github.event.repository.name }} ${{ github.event.inputs.tag_name || github.ref_name || 'v-manual' }}  version"

on:
  push:
    branches:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'è¾“å…¥ Release æ ‡ç­¾ (eg: v0.35.1, v0.36.5-alpha.1)'
        required: false
        type: string
        default: 'v-manual'
      skip_tests:
        description: 'æ˜¯å¦è·³è¿‡æµ‹è¯• (true/false)'
        required: true
        type: boolean
        default: false
      java_version:
        description: 'è¾“å…¥ Java ç‰ˆæœ¬ (å¦‚ 8, 11, 17)'
        required: true
        default: '8'
      jar_dir_prefix:
        description: 'JAR æ–‡ä»¶å‰ç¼€ (å¦‚ bgi-tools æˆ–ç•™ç©º)'
        default: ''
      draft:
        description: 'æ˜¯å¦ä¸ºè‰ç¨¿ Release (true/false)'
        type: boolean
        default: false
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒ Release (true/false)'
        type: boolean
        default: false
      push_to_docker_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°dockeré•œåƒä»“åº“'
        required: true
        type: boolean
        default: false
      push_to_github_release:
        description: 'æ˜¯å¦æ¨é€åˆ°Github Release'
        required: true
        type: boolean
        default: false
      desc:
        description: 'Release æè¿°ä¿¡æ¯'
        required: false
        type: string
        default: ''
      icon_path:
        description: 'icon å›¾æ ‡'
        required: false
        type: string
        default: 'frontend/public/logo.ico'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # åœ¨ Linux ä¸Šæ„å»º JAR å¹¶æ‰“åŒ…ä¸º ZIP
  build-jar-linux:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.set_vars.outputs.tag_name }}
      java_version: ${{ steps.set_vars.outputs.java_version }}
      jar_dir_prefix: ${{ steps.set_vars.outputs.jar_dir_prefix }}
      push_to_docker_registry: ${{ steps.set_vars.outputs.push_to_docker_registry }}
      push_to_github_release: ${{ steps.set_vars.outputs.push_to_github_release }}
    permissions:
      contents: write
      actions: read
    steps:
      - name: 1. è°ƒè¯•è§¦å‘ä¿¡æ¯
        run: |
          echo "äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
          echo "å¼•ç”¨: ${{ github.ref }}"
          echo "æ ‡ç­¾å: ${{ github.event.inputs.tag_name || github.ref_name }}"
          echo "è·³è¿‡æµ‹è¯•: ${{ github.event.inputs.skip_tests || true }}"
          echo "Java ç‰ˆæœ¬: ${{ github.event.inputs.java_version || secrets.JAVA_VERSION || '8' }}"
          echo "JAR å‰ç¼€: ${{ github.event.inputs.jar_dir_prefix || 'bgi-tools' }}"
          echo "è‰ç¨¿: ${{ github.event.inputs.draft || false }}"
          echo "é¢„å‘å¸ƒ: ${{ github.event.inputs.prerelease || false }}"
          echo "ä»“åº“: ${{ github.repository }}"
          echo "æäº¤ SHA: ${{ github.sha }}"

      - name: 2. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 3. è®¾ç½®è¾“å…¥å‚æ•°å’Œç¯å¢ƒå˜é‡
        id: set_vars
        run: |
          # åˆå§‹åŒ–é»˜è®¤å€¼
          TAG_NAME="${{ github.event.inputs.tag_name || github.ref_name || 'v-manual' }}"

          # å¤„ç†å¸ƒå°”å€¼ï¼ˆinputs ä¸ºå­—ç¬¦ä¸²ï¼Œéœ€è¦è½¬æ¢ï¼‰
          SKIP_TESTS="${{ inputs.skip_tests || 'false' }}"
          if [[ "$SKIP_TESTS" == "true" || "$SKIP_TESTS" == "1" ]]; then
            SKIP_TESTS=true
          else
            SKIP_TESTS=false
          fi

          JAVA_VERSION="${{ inputs.java_version || secrets.JAVA_VERSION || '8' }}"
          JAR_DIR_PREFIX="${{ inputs.jar_dir_prefix || 'bgi-tools' }}"
          DRAFT="${{ inputs.draft || 'false' }}"
          PRERELEASE="${{ inputs.prerelease || 'false' }}"

          EVENT_NAME="${{ github.event_name }}"

          # é»˜è®¤å€¼
          AUTO=false
          PUSH_TO_DOCKER_REGISTRY=false
          PUSH_TO_GITHUB_RELEASE=false

          # æ ¸å¿ƒåˆ¤æ–­ï¼šè‡ªåŠ¨å‘å¸ƒæˆ–æ‰‹åŠ¨å‘å¸ƒ
          if [[ "$EVENT_NAME" == "push" ]] && [[ "$TAG_NAME" == v* ]]; then
            AUTO=true
            PUSH_TO_DOCKER_REGISTRY=true
            PUSH_TO_GITHUB_RELEASE=true
          elif [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            [[ "${{ inputs.push_to_docker_registry }}" == "true" ]] && PUSH_TO_DOCKER_REGISTRY=true
            [[ "${{ inputs.push_to_github_release }}" == "true" ]] && PUSH_TO_GITHUB_RELEASE=true
          fi

          # å†™å…¥ç¯å¢ƒå˜é‡
          echo "AUTO=$AUTO" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "SKIP_TESTS=$SKIP_TESTS" >> $GITHUB_ENV
          echo "JAVA_VERSION=$JAVA_VERSION" >> $GITHUB_ENV
          echo "JAR_DIR_PREFIX=$JAR_DIR_PREFIX" >> $GITHUB_ENV
          echo "DRAFT=$DRAFT" >> $GITHUB_ENV
          echo "PRERELEASE=$PRERELEASE" >> $GITHUB_ENV
          echo "PUSH_TO_DOCKER_REGISTRY=$PUSH_TO_DOCKER_REGISTRY" >> $GITHUB_ENV
          echo "PUSH_TO_GITHUB_RELEASE=$PUSH_TO_GITHUB_RELEASE" >> $GITHUB_ENV

          # è®¾ç½® job è¾“å‡º
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "java_version=$JAVA_VERSION" >> $GITHUB_OUTPUT
          echo "jar_dir_prefix=$JAR_DIR_PREFIX" >> $GITHUB_OUTPUT
          echo "push_to_docker_registry=$PUSH_TO_DOCKER_REGISTRY" >> $GITHUB_OUTPUT
          echo "push_to_github_release=$PUSH_TO_GITHUB_RELEASE" >> $GITHUB_OUTPUT

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "æœ€ç»ˆè®¾ç½®å€¼ï¼š"
          echo "  AUTO                   : $AUTO"
          echo "  TAG_NAME               : $TAG_NAME"
          echo "  SKIP_TESTS             : $SKIP_TESTS"
          echo "  JAVA_VERSION           : $JAVA_VERSION"
          echo "  JAR_DIR_PREFIX         : $JAR_DIR_PREFIX"
          echo "  DRAFT                  : $DRAFT"
          echo "  PRERELEASE             : $PRERELEASE"
          echo "  PUSH_TO_DOCKER_REGISTRY: $PUSH_TO_DOCKER_REGISTRY"
          echo "  PUSH_TO_GITHUB_RELEASE : $PUSH_TO_GITHUB_RELEASE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: 4. éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
        run: |
          echo "å½“å‰ç‰ˆæœ¬å·: $TAG_NAME"
          if ! [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬æ ¼å¼å¿…é¡»ç¬¦åˆ SemVer è§„èŒƒ"
            exit 1
          fi
          echo "ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"

      - name: 5. è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: 6. ç¼“å­˜ Maven ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: 7. ä½¿ç”¨ Maven æ„å»ºé¡¹ç›®
        run: |
          if [ "${{ env.SKIP_TESTS }}" = "true" ]; then
            echo "è·³è¿‡æµ‹è¯•"
            mvn clean package -B -DskipTests -Dquickly
          else
            mvn clean package -B -Dquickly
          fi

      - name: 8. åˆ—å‡ºç”Ÿæˆçš„ JAR æ–‡ä»¶
        run: |
          find . -type f -name "*.jar" -path "*/target/*" || echo "æœªæ‰¾åˆ° JAR æ–‡ä»¶"

      - name: 9. å°† JAR æ–‡ä»¶æ‰“åŒ…æˆ ZIP
        run: |
          find . -type f -name "*.jar" -path "*/target/*" -exec zip -j jars-${{ env.TAG_NAME }}.zip {} +

      - name: 10. éªŒè¯ JAR ZIP æ–‡ä»¶
        run: |
          ls -la jars-${{ env.TAG_NAME }}.zip
          unzip -l jars-${{ env.TAG_NAME }}.zip

      - name: 11. ä¸Šä¼  JAR ZIP ä¾› Windows ä½¿ç”¨
        uses: actions/upload-artifact@v4
        with:
          name: jars-zip
          path: jars-${{ env.TAG_NAME }}.zip

      - name: 12. ä¸Šä¼ å•ä¸ª JAR æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: jar-files
          path: "**/target/*.jar"
#       - name: 12. å°† JAR æ–‡ä»¶è½¬æ¢ä¸ºç‹¬ç«‹ EXEï¼ˆæ†ç»‘ç§æœ‰ JREï¼Œå®Œå…¨ç‹¬ç«‹è¿è¡Œï¼‰
  #        run: |
  #          # ============ ä¸‹è½½ Launch4j ============
  #          wget --tries=5 --timeout=60 \
  #            https://pilotfiber.dl.sourceforge.net/project/launch4j/launch4j-3/3.50/launch4j-3.50-linux-x64.tgz?viasf=1 \
  #            -O /tmp/launch4j.tgz || \
  #          wget --tries=5 \
  #            https://sourceforge.net/projects/launch4j/files/launch4j-3/3.50/launch4j-3.50-linux-x64.tgz/download \
  #            -O /tmp/launch4j.tgz
  #
  #          tar -xzf /tmp/launch4j.tgz -C /tmp
  #
  #          #sudo apt-get update
  #          #sudo apt-get install -y mingw-w64 g++-mingw-w64-i686 gcc-mingw-w64-i686 binutils-mingw-w64-i686
  #
  #          sudo apt-get update
  #          sudo dpkg --add-architecture i386
  #          sudo apt-get install -y libc6:i386 libgcc-s1:i386
  #          sudo apt-get install -y mingw-w64 g++-mingw-w64-i686 gcc-mingw-w64-i686 binutils-mingw-w64-i686
  #
  #
  #          ln -sf /usr/bin/i686-w64-mingw32-windres /tmp/launch4j/bin/windres
  #          ln -sf /usr/bin/i686-w64-mingw32-ld /tmp/launch4j/bin/ld
  #
  #          # ============ ä¸‹è½½ Windows x64 JDK ç”¨äºæå–/æ†ç»‘è¿è¡Œæ—¶ ============
  #          echo "ğŸ“¦ æ­£åœ¨ä¸‹è½½ Adoptium Temurin Java ${{ env.JAVA_VERSION }} Windows x64 JDK"
  #
  #          sudo apt-get install -y jq
  #
  #          API_URL="https://api.adoptium.net/v3/assets/latest/${{ env.JAVA_VERSION }}/hotspot?image_type=jdk&os=windows&arch=x64&vendor=adoptium"
  #
  #          DOWNLOAD_URL=$(curl -s -f "$API_URL" | jq -r '.[0].binary.package.link // empty')
  #
  #          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
  #            echo "âŒ Adoptium API æœªè¿”å›æœ‰æ•ˆä¸‹è½½é“¾æ¥"
  #            echo "è¯·æ£€æŸ¥ç‰ˆæœ¬ ${{ env.JAVA_VERSION }} æ˜¯å¦å­˜åœ¨ï¼Œæˆ–ç½‘ç»œé—®é¢˜"
  #            exit 1
  #          fi
  #
  #          echo "ä¸‹è½½é“¾æ¥: $DOWNLOAD_URL"
  #          wget -q --show-progress "$DOWNLOAD_URL" -O /tmp/jdk.zip || { echo "ä¸‹è½½å¤±è´¥"; exit 1; }
  #
  #          # è§£å‹åˆ°ä¸´æ—¶ç›®å½•
  #          TEMP_EXTRACT_DIR=$(mktemp -d /tmp/jdk_extract_XXXXXX)
  #          unzip -q /tmp/jdk.zip -d "$TEMP_EXTRACT_DIR"
  #
  #          JDK_ROOT_DIR=$(find "$TEMP_EXTRACT_DIR" -mindepth 1 -maxdepth 1 -type d | head -1)
  #
  #          if [ -z "$JDK_ROOT_DIR" ]; then
  #            echo "âŒ æœªæ‰¾åˆ°è§£å‹åçš„ JDK æ ¹ç›®å½•"
  #            ls -la "$TEMP_EXTRACT_DIR"
  #            exit 1
  #          fi
  #
  #          echo "JDK æ ¹ç›®å½•: $JDK_ROOT_DIR"
  #          ls -la "$JDK_ROOT_DIR" | head -n 8
  #
  #          # ============ æ ¹æ®ç‰ˆæœ¬å¤„ç†è¿è¡Œæ—¶ ============
  #          mkdir -p extracted-jars
  #
  #          JAVA_VER_NUM=$((10#${{ env.JAVA_VERSION }}))
  #
  #          if (( JAVA_VER_NUM <= 8 )); then
  #            JRE_SOURCE_DIR="$JDK_ROOT_DIR/jre"
  #            if [ ! -d "$JRE_SOURCE_DIR" ]; then
  #              echo "âŒ JDK 8 æ¨¡å¼ä¸‹æœªæ‰¾åˆ° jre å­ç›®å½•"
  #              ls -la "$JDK_ROOT_DIR"
  #              exit 1
  #            fi
  #            mv "$JRE_SOURCE_DIR" extracted-jars/jre
  #            echo "âœ… å·²æå– JDK 8 ç§æœ‰ JRE"
  #          else
  #            # JDK 9+ ç›´æ¥ä½¿ç”¨æ•´ä¸ª JDK ä½œä¸ºè¿è¡Œæ—¶ï¼Œé‡å‘½åä¸º jre
  #            mv "$JDK_ROOT_DIR" extracted-jars/jre
  #            echo "âœ… ä½¿ç”¨å®Œæ•´ JDK ä½œä¸ºæ†ç»‘è¿è¡Œæ—¶ï¼ˆJava ${{ env.JAVA_VERSION }}ï¼‰"
  #            echo "  â†’ è¿è¡Œæ—¶ç›®å½•ç»“æ„ç¤ºä¾‹ï¼š"
  #            ls -la extracted-jars/jre | head -n 8
  #          fi
  #
  #          # æ˜¾ç¤ºå¤§å°ç»Ÿè®¡
  #          echo "æ†ç»‘è¿è¡Œæ—¶å¤§å°ï¼š"
  #          du -sh extracted-jars/jre
  #
  #          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
  #          rm -rf "$TEMP_EXTRACT_DIR" /tmp/jdk.zip
  #
  #          # ============ ç‰ˆæœ¬ä¿¡æ¯å¤„ç† ============
  #          RAW_TAG=${TAG_NAME#v}
  #          RAW_TAG=${RAW_TAG:-0.0.1}
  #          CLEAN_VERSION=$(echo "$RAW_TAG" | sed 's/[^0-9.]//g' | sed 's/^\.*//; s/\.*$//; s/\.\.+/\./g')
  #          CLEAN_VERSION=${CLEAN_VERSION:-0.0.1}
  #
  #          IFS='.' read -r -a parts <<< "$CLEAN_VERSION"
  #          major=${parts[0]:-0} minor=${parts[1]:-0} patch=${parts[2]:-0} build=${parts[3]:-0}
  #          FILE_VERSION="$major.$minor.$patch.$build"
  #          TXT_VERSION="${TAG_NAME:-v$major.$minor.$patch}"
  #          echo "ç‰ˆæœ¬ä¿¡æ¯: FileVersion=$FILE_VERSION, TxtVersion=$TXT_VERSION"
  #
  #          # ============ ä¸ºæ¯ä¸ª JAR ç”Ÿæˆç‹¬ç«‹ EXE ============
  #          for jar_file in extracted-jars/*.jar; do
  #            [ -f "$jar_file" ] || { echo "âŒ æœªæ‰¾åˆ°ä»»ä½• JAR æ–‡ä»¶"; exit 1; }
  #            jar_name=$(basename "$jar_file" .jar)
  #            exe_file="extracted-jars/${jar_name}.exe"
  #
  #            abs_jar=$(realpath "$jar_file")
  #            abs_exe=$(realpath -m "$exe_file")
  #
  #            main_class=$(unzip -p "$jar_file" META-INF/MANIFEST.MF | grep '^Main-Class:' | sed 's/^Main-Class: *//' | tr -d '\r')
  #            if [ -z "$main_class" ]; then
  #              echo "âš ï¸ $jar_file æ—  Main-Classï¼Œè·³è¿‡ç”Ÿæˆ EXE"
  #              continue
  #            fi
  #
  #            config_file="/tmp/launch4j_${jar_name}_config.xml"
  #            cat > "$config_file" << EOF
  #          <launch4jConfig>
  #            <dontWrapJar>false</dontWrapJar>
  #            <headerType>console</headerType>
  #            <jar>$abs_jar</jar>
  #            <outfile>$abs_exe</outfile>
  #            <errTitle>${{ github.event.repository.name }} Error</errTitle>
  #            <classPath>
  #              <mainClass>$main_class</mainClass>
  #            </classPath>
  #            <jre>
  #              <path>jre;%JAVA_HOME%;%PATH%</path>
  #              <minVersion>${{ env.JAVA_VERSION }}.0</minVersion>
  #              <maxVersion>${{ env.JAVA_VERSION }}.999</maxVersion>
  #              <jdkPreference>preferBundled</jdkPreference>
  #              <requiresJdk>false</requiresJdk>
  #            </jre>
  #            <versionInfo>
  #              <fileVersion>$FILE_VERSION</fileVersion>
  #              <txtFileVersion>$TXT_VERSION</txtFileVersion>
  #              <productVersion>$FILE_VERSION</productVersion>
  #              <txtProductVersion>$TXT_VERSION</txtProductVersion>
  #              <fileDescription>${{ github.event.repository.name }} Standalone (Java ${{ env.JAVA_VERSION }})</fileDescription>
  #              <copyright>Copyright (c) 2023-$(date +%Y)</copyright>
  #              <productName>${{ github.event.repository.name }}</productName>
  #              <internalName>${jar_name}</internalName>
  #              <originalFilename>${jar_name}.exe</originalFilename>
  #            </versionInfo>
  #            <!-- æ·»åŠ å›¾æ ‡é…ç½® -->
  #            <icon>/home/runner/work/${{github.event.repository.name }}/${{github.event.repository.name }}/${{ github.event.inputs.icon_path }}</icon>
  #          </launch4jConfig>
  #          EOF
  #
  #            echo "ç”Ÿæˆ EXE é…ç½®: $config_file"
  #            echo "æ­£åœ¨ç”Ÿæˆç‹¬ç«‹ EXE: $exe_file"
  #
  #            java -Djava.awt.headless=true -jar /tmp/launch4j/launch4j.jar "$config_file"
  #
  #            if [ -f "$exe_file" ]; then
  #              echo "ğŸ‰ æˆåŠŸç”Ÿæˆ: $exe_file (å¤§å°: $(du -h "$exe_file" | cut -f1))"
  #            else
  #              echo "âŒ ç”Ÿæˆå¤±è´¥"
  #              cat /tmp/launch4j/launch4j.log 2>/dev/null || true
  #              exit 1
  #            fi
  #          done
  #
  #          echo "=== æœ€ç»ˆ extracted-jars ç›®å½•å†…å®¹ ==="
  #          ls -lh extracted-jars/
  #          du -sh extracted-jars/jre extracted-jars/*.exe 2>/dev/null || true
  #
  #          # æ¸…ç† Launch4j ä¸´æ—¶æ–‡ä»¶
  #          rm -rf /tmp/launch4j /tmp/launch4j.tgz /tmp/launch4j_*_config.xml
  #        shell: bash
  #
  #
  #      - name: 13. æ‰“åŒ…ä»…å« EXE + JRE + é…ç½®æ–‡ä»¶çš„ç‹¬ç«‹è¿è¡ŒåŒ…
  #        run: |
  #          # åˆ›å»ºä¸´æ—¶æ‰“åŒ…ç›®å½•
  #          mkdir -p standalone-package
  #
  #          # å¤åˆ¶ EXE å’Œ jre æ–‡ä»¶å¤¹
  #          cp extracted-jars/*.exe standalone-package/ 2>/dev/null || echo "æ—  EXE"
  #          cp -r extracted-jars/jre standalone-package/ 2>/dev/null || echo "æ—  jre"
  #
  #          # å…³é”®ï¼šå¤åˆ¶ application-prod.yml åˆ°æ‰“åŒ…ç›®å½•ï¼ˆä¸ EXE åŒçº§ï¼‰
  #          if [ -f src/main/resources/application-prod.yml ]; then
  #            cp src/main/resources/application-prod.yml standalone-package/
  #            echo "âœ… å·²åŒ…å« application-prod.yml é…ç½®æ–‡ä»¶"
  #          else
  #            echo "âš ï¸ æœªæ‰¾åˆ° src/main/resources/application-prod.ymlï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿åˆ›å»º"
  #            cat > standalone-package/application-prod.yml << 'EOF'
  #          server:
  #            port: 8081
  #            #servlet:
  #              #context-path: /bgi #ä¸è¦ä¿®æ”¹
  #
  #          ws:
  #            url: ws://localhost:8081/ws # å¯å¿½ç•¥ï¼Œç¨‹åºå†…éƒ¨è‡ªåŠ¨è®¡ç®—
  #            access-token-name: access-token
  #          EOF
  #          fi
  #
  #          # æ‰“æˆ ZIP
  #          cd standalone-package
  #          zip -r ../${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip ./*
  #          cd ..
  #
  #          echo "âœ… ç‹¬ç«‹è¿è¡ŒåŒ…æ‰“åŒ…å®Œæˆï¼ˆåŒ…å« EXE + jre + application-prod.ymlï¼‰"
  #          ls -lh ${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip
  #          du -sh ${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip
  #
  #      - name: 14. ä¸Šä¼ åˆ° GitHub Releaseï¼ˆåŒ…å«ç‹¬ç«‹ EXE åŒ…ï¼‰
  #        uses: softprops/action-gh-release@v2
  #        if: ${{ env.PUSH_TO_GITHUB_RELEASE == 'true' }}
  #        #if: ${{ github.event_name == 'push' || inputs.push_to_github_release == true }}
  #        with:
  #          name: ${{ env.TAG_NAME }}
  #          tag_name: ${{ env.TAG_NAME }}
  #          files: |
  #            jars-${{ env.TAG_NAME }}.zip
  #            extracted-jars/*.jar
  #            extracted-jars/*.exe
  #            ${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip
  #          body: |
  #            **Release ä¿¡æ¯**
  #            - æ ‡ç­¾: ${{ env.TAG_NAME }}
  #            - Java ç‰ˆæœ¬: ${{ env.JAVA_VERSION}}
  #            **${{ github.event.repository.name }} ${{ env.TAG_NAME }} å‘å¸ƒ**
  #
  #            ### ğŸ† æ¨èä¸‹è½½ï¼ˆå®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€å®‰è£… Javaï¼‰
  #            - **${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip**
  #              â†’ è§£å‹åç›´æ¥åŒå‡» `.exe` æ–‡ä»¶è¿è¡Œï¼ˆå·²å†…ç½® Java è¿è¡Œæ—¶ï¼‰
  #
  #            ### ğŸ“¦ å…¶ä»–æ–‡ä»¶
  #            - `jars-${{ env.TAG_NAME }}.zip`ï¼šåŸå§‹ JAR åŒ…
  #            - å•ä¸ª `.jar` æ–‡ä»¶ï¼šä¾›å¼€å‘è€…ä½¿ç”¨
  #            - å•ä¸ª `.exe` æ–‡ä»¶ï¼šä»… EXEï¼ˆéœ€ç³»ç»Ÿå·²å®‰è£… Java ${{ env.JAVA_VERSION}}ï¼‰
  #
  #            ${{github.event.inputs.desc}}
  #
  #            **ç³»ç»Ÿè¦æ±‚**ï¼šWindows 10/11 x64
  #            **è¿è¡Œæ–¹å¼**ï¼šæ¨èä½¿ç”¨ç‹¬ç«‹åŒ…ï¼ŒåŒå‡»å³è·‘
  #
  #            å¦‚æœ‰é—®é¢˜æ¬¢è¿åé¦ˆï¼
  #          draft: ${{ env.DRAFT == true || false }}
  #          prerelease: ${{ env.PRERELEASE == true || false }}
  #        env:
  #          GITHUB_TOKEN: ${{ secrets.PAT }}
  #
  #      # åœ¨æ­¥éª¤ ä¹‹åæ·»åŠ æ–°çš„ artifact ä¸Šä¼ æ­¥éª¤
  #      - name: Upload JAR files as artifact
  #        uses: actions/upload-artifact@v4
  #        with:
  #          name: jar-files
  #          path: extracted-jars/*.jar
  #
  #      - name: ä¸Šä¼ ç‹¬ç«‹ EXE åŒ…ä½œä¸º Artifact
  #        uses: actions/upload-artifact@v4
  #        with:
  #          name: ${{ github.event.repository.name }}-Windows-Standalone
  #          path: ${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip
  build-exe-windows:
    runs-on: windows-latest
    needs: build-jar-linux
    permissions:
      contents: write
    env:
      TAG_NAME: ${{ needs.build-jar-linux.outputs.tag_name }}
      JAVA_VERSION: ${{ needs.build-jar-linux.outputs.java_version }}
      JAR_DIR_PREFIX: ${{ needs.build-jar-linux.outputs.jar_dir_prefix }}
      ICON_PATH: ${{ github.event.inputs.icon_path || 'frontend/public/logo.ico' }}
    steps:
      - name: 1.æ£€å‡ºä»£ç ï¼ˆç”¨äºå›¾æ ‡å’Œé…ç½®ï¼‰
        uses: actions/checkout@v4

      - name: 2.ä¸‹è½½ JARs ZIP
        uses: actions/download-artifact@v4
        with:
          name: jars-zip
          path: ./

      - name: 3.è§£å‹ JARs åˆ° extracted-jars
        run: |
          mkdir extracted-jars
          Expand-Archive -Path "jars-${{ env.TAG_NAME }}.zip" -DestinationPath extracted-jars
          dir extracted-jars

      - name: 4.è®¾ç½® Java ç¯å¢ƒ version=${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: 5. ä¸‹è½½ Launch4jï¼ˆä½¿ç”¨ direct linkï¼‰
        run: |
          $url = "https://downloads.sourceforge.net/project/launch4j/launch4j-3/3.50/launch4j-3.50-win32.zip"
          
          curl.exe -L -o launch4j.zip "$url" --retry 5 --retry-delay 10 --connect-timeout 30
          
          if (-not (Test-Path launch4j.zip)) {
            Write-Error "curl ä¸‹è½½å¤±è´¥"
            exit 1
          }
          
          Write-Output "ä¸‹è½½å®Œæˆï¼Œå¤§å°ï¼š"
          Get-Item launch4j.zip | Select Length
          
          Expand-Archive launch4j.zip -DestinationPath launch4j -Force
          Remove-Item launch4j.zip
          
          dir launch4j

      - name: 6.ä¸‹è½½ Windows JDK ç”¨äºæ†ç»‘ JRE
        run: |
          # ä½¿ç”¨ PowerShell ä¸‹è¼‰ Adoptium Temurin Windows x64 ZIP
          # å®šç¾© API åœ°å€ï¼Œç”¨æ–¼ç²å–æŒ‡å®š Java ç‰ˆæœ¬çš„æœ€æ–° JDK ä¸‹è¼‰éˆæ¥
          $apiUrl = "https://api.adoptium.net/v3/assets/latest/${{ env.JAVA_VERSION }}/hotspot?image_type=jdk&os=windows&arch=x64&vendor=adoptium"
          
          # èª¿ç”¨ REST API ç²å–ä¸‹è¼‰éˆæ¥ï¼Œä¸¦æå–ç¬¬ä¸€å€‹çµæœçš„ä¸‹è¼‰åœ°å€
          $downloadUrl = (Invoke-RestMethod -Uri $apiUrl)[0].binary.package.link
          
          # å¦‚æœæ²’æœ‰ç²å–åˆ°ä¸‹è¼‰éˆæ¥ï¼Œå‰‡è¼¸å‡ºéŒ¯èª¤ä¸¦é€€å‡ºè…³æœ¬
          if (-not $downloadUrl) { 
              Write-Error "No download URL found"; 
              exit 1 
          }
          
          # è¼¸å‡ºç•¶å‰æ­£åœ¨ä¸‹è¼‰çš„ URL
          Write-Output "Downloading from $downloadUrl"
          
          # ä½¿ç”¨ WebRequest ä¸‹è¼‰ JDK ZIP æ–‡ä»¶
          Invoke-WebRequest -Uri $downloadUrl -OutFile jdk.zip
          
          # è§£å£“ä¸‹è¼‰çš„ ZIP æ–‡ä»¶åˆ°è‡¨æ™‚ç›®éŒ„ jdk_extract
          Expand-Archive -Path jdk.zip -DestinationPath jdk_extract
          
          # ç²å–è§£å£“å¾Œçš„ç¬¬ä¸€å€‹ç›®éŒ„ï¼ˆå³ JDK æ ¹ç›®éŒ„ï¼‰
          $jdkRoot = Get-ChildItem jdk_extract | Where-Object { $_.PSIsContainer } | Select-Object -First 1 -ExpandProperty FullName
          
          # åˆ¤æ–· Java ç‰ˆæœ¬æ˜¯å¦å°æ–¼ç­‰æ–¼ 8
          if ($env:JAVA_VERSION -le 8) {
              # å°æ–¼ JDK 8 åŠä»¥ä¸‹ç‰ˆæœ¬ï¼Œå°‡ jre ç›®éŒ„ç§»å‹•åˆ° extracted-jars/jre
              Move-Item -Path "$jdkRoot\jre" -Destination extracted-jars\jre
          } else {
              # å°æ–¼ JDK 9 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå°‡æ•´å€‹ JDK ç›®éŒ„é‡å‘½åç‚º jre ä¸¦ç§»å‹•åˆ° extracted-jars/jre
              Rename-Item -Path $jdkRoot -NewName jre
              Move-Item -Path jre -Destination extracted-jars\jre
          }
          
          # æ¸…ç†è‡¨æ™‚æ–‡ä»¶å’Œç›®éŒ„
          Remove-Item jdk.zip, jdk_extract -Recurse -Force

      - name: 7. ä½¿ç”¨ Launch4j ä¸ºæ¯ä¸ª JAR ç”Ÿæˆ EXE
        run: |
          # è·å– extracted-jars ç›®å½•ä¸‹æ‰€æœ‰çš„ .jar æ–‡ä»¶
          $jars = Get-ChildItem extracted-jars -Filter *.jar

          foreach ($jar in $jars) {
            $jarName = $jar.BaseName
            $exeFile = "extracted-jars\$jarName.exe"
            $absJar = $jar.FullName
            $absExe = (Resolve-Path $exeFile).Path

            # æå– Main-Class
            & jar xf $absJar META-INF/MANIFEST.MF 2>$null
            $mainClassLine = Get-Content META-INF/MANIFEST.MF | Where-Object { $_ -match "^Main-Class:" }
            $mainClass = if ($mainClassLine) { $mainClassLine -replace "^Main-Class:\s*", "" -replace "\s*$", "" } else { $null }
            Remove-Item META-INF -Recurse -Force -ErrorAction SilentlyContinue

            if (-not $mainClass) {
              Write-Warning "No Main-Class in $jarName.jar, skipping"
              continue
            }

            # ç‰ˆæœ¬å¤„ç†
            $rawTag = "${{ env.TAG_NAME }}".TrimStart('v')
            $cleanVersion = $rawTag -replace '[^0-9.]','' -replace '\.+','.'
            $parts = $cleanVersion.Split('.')
            $major = if ($parts[0]) { $parts[0] } else { '0' }
            $minor = if ($parts[1]) { $parts[1] } else { '0' }
            $patch = if ($parts[2]) { $parts[2] } else { '0' }
            $build = if ($parts[3]) { $parts[3] } else { '0' }
            $fileVersion = "$major.$minor.$patch.$build"
            $txtVersion = "${{ env.TAG_NAME }}"

            # XML é…ç½®ï¼ˆç»“æŸç¬¦ @ å¿…é¡»ç‹¬å ä¸€è¡Œã€æ— å‰ç½®ç©ºæ ¼ï¼‰
            $config = @"
          <launch4jConfig>
          <dontWrapJar>false</dontWrapJar>
          <headerType>console</headerType>
          <jar>$absJar</jar>
          <outfile>$absExe</outfile>
          <errTitle>${{ github.event.repository.name }} Error</errTitle>
          <classPath><mainClass>$mainClass</mainClass></classPath>
          <jre>
          <path>jre;%JAVA_HOME%;%PATH%</path>
          <minVersion>${{ env.JAVA_VERSION }}.0</minVersion>
          <maxVersion>${{ env.JAVA_VERSION }}.999</maxVersion>
          <jdkPreference>preferBundled</jdkPreference>
          </jre>
          <versionInfo>
          <fileVersion>$fileVersion</fileVersion>
          <txtFileVersion>$txtVersion</txtFileVersion>
          <productVersion>$fileVersion</productVersion>
          <txtProductVersion>$txtVersion</txtProductVersion>
          <fileDescription>${{ github.event.repository.name }} Standalone (Java ${{ env.JAVA_VERSION }})</fileDescription>
          <copyright>Copyright (c) 2023-$(Get-Date -Format yyyy)</copyright>
          <productName>${{ github.event.repository.name }}</productName>
          <internalName>$jarName</internalName>
          <originalFilename>$jarName.exe</originalFilename>
          </versionInfo>
          <icon>${{ github.workspace }}\${{ env.ICON_PATH }}</icon>
          </launch4jConfig>
          "@
        
                    $config | Out-File -FilePath "config_$jarName.xml" -Encoding utf8
          
          & .\launch4j\launch4j.exe "config_$jarName.xml"
          
          if (Test-Path $exeFile) {
            Write-Output "Success: $exeFile created"
          } else {
            Write-Error "Failed to create $exeFile"
            exit 1
          }
        }
      - name: æ‰“åŒ…ç‹¬ç«‹è¿è¡ŒåŒ…ï¼ˆEXE + JRE + é…ç½®æ–‡ä»¶ï¼‰
        run: |
          # åˆ›å»ºä¸€ä¸ªåä¸º standalone-package çš„ç›®å½•ï¼Œç”¨äºå­˜æ”¾æœ€ç»ˆçš„ç‹¬ç«‹è¿è¡ŒåŒ…
          mkdir standalone-package
          
          # å°† extracted-jars ç›®å½•ä¸‹çš„æ‰€æœ‰ .exe æ–‡ä»¶å¤åˆ¶åˆ° standalone-package ç›®å½•ä¸­
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ° .exe æ–‡ä»¶ï¼Œåˆ™å¿½ç•¥é”™è¯¯ç»§ç»­æ‰§è¡Œ
          Copy-Item extracted-jars\*.exe standalone-package\ -ErrorAction SilentlyContinue
          
          # å°† extracted-jars ç›®å½•ä¸‹çš„ jre æ–‡ä»¶å¤¹é€’å½’å¤åˆ¶åˆ° standalone-package ç›®å½•ä¸­
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ° jre æ–‡ä»¶å¤¹ï¼Œåˆ™å¿½ç•¥é”™è¯¯ç»§ç»­æ‰§è¡Œ
          Copy-Item -Recurse extracted-jars\jre standalone-package\ -ErrorAction SilentlyContinue
          
          # å®šä¹‰ application-prod.yml æ–‡ä»¶çš„è·¯å¾„
          $prodYml = "src\main\resources\application-prod.yml"
          
          # æ£€æŸ¥ application-prod.yml æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (Test-Path $prodYml) {
              # å¦‚æœå­˜åœ¨ï¼Œåˆ™å°†å…¶å¤åˆ¶åˆ° standalone-package ç›®å½•ä¸­
              Copy-Item $prodYml standalone-package\
          } else {
              # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ application-prod.yml æ–‡ä»¶
              @"
          server:
            port: 8081
          ws:
            url: ws://localhost:8081/ws
            access-token-name: access-token
          "@ | Out-File standalone-package\application-prod.yml -Encoding utf8
          }
          
          # å°† standalone-package ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶å‹ç¼©æˆä¸€ä¸ª ZIP æ–‡ä»¶
          # ZIP æ–‡ä»¶çš„åç§°ä¸ºä»“åº“å + Windows + æ ‡ç­¾å + .zip
          Compress-Archive -Path standalone-package\* -DestinationPath "${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip" -Force

      - name: ä¸Šä¼ ç‹¬ç«‹è¿è¡ŒåŒ…ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-standalone
          path: ${{ github.event.repository.name }}-Windows-${{ env.TAG_NAME }}.zip

      - name: ä¸Šä¼ å•ä¸ª EXE æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: windows-exes
          path: extracted-jars\*.exe


  build-and-push-docker:
    runs-on: ubuntu-latest
    needs: build-jar-linux  # æ·»åŠ ä¾èµ–å…³ç³»
    permissions:
      contents: read
      packages: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ä¸‹è½½ä¹‹å‰å·¥ä½œæµçš„æ„å»ºäº§ç‰©
      - name: Download JAR artifacts
        uses: actions/download-artifact@v4
        with:
          name: jar-files
          path: ./

      - name: List downloaded files
        run: ls -la ./

      - name: é…ç½®
        run: |
          DOCKER_FILE_NAME="Dockerfile"
          if [ -f "$DOCKER_FILE_NAME" ]; then
              echo "$DOCKER_FILE_NAME already exists"
              cat "$DOCKER_FILE_NAME"
          else
              cat > "$DOCKER_FILE_NAME" << EOF
              FROM eclipse-temurin:${{ needs.build-jar-linux.outputs.java_version }}-jre-alpine
              VOLUME /tmp
              WORKDIR /app
              COPY *.jar app.jar
              ENTRYPOINT ["java","-jar","app.jar"]
          EOF
              if [ -f "$DOCKER_FILE_NAME" ]; then
                echo "$DOCKER_FILE_NAME created successfully"
                cat "$DOCKER_FILE_NAME"
              else
              echo "Error: $DOCKER_FILE_NAME creation failed"
              exit 1
              fi
          fi          
          
          echo "DOCKER_FILE_NAME=$DOCKER_FILE_NAME" >> $GITHUB_ENV

      # è®¾ç½® Docker Buildx
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v2

      # ç™»å½•åˆ° GitHub Container Registry
      - name: ç™»å½• Log in to Container Registry
        if: ${{ needs.build-jar-linux.outputs.push_to_docker_registry == 'true' }}
        #if: ${{ github.event_name == 'push' || inputs.push_to_docker_registry == true }}
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æå– Docker é•œåƒå…ƒæ•°æ®
      - name: æå– Docker é•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ github.ref_name }}
            type=raw,value=latest
      

      # æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: æ„å»ºå¹¶æ¨é€ Docker image
        uses: docker/build-push-action@v4
        #if: ${{ needs.build-jar-linux.outputs.push_to_docker_registry == 'true' }}
        #if: ${{ github.event_name == 'push' || inputs.push_to_docker_registry == true }}
        with:
          context: .
          file: ./${{ env.DOCKER_FILE_NAME}}
          push: ${{ needs.build-jar-linux.outputs.push_to_docker_registry == 'true' }}
          #push: ${{ github.event_name == 'push' || inputs.push_to_docker_registry == true }}
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            JAVA_VERSION=${{needs.build-jar-linux.outputs.java_version}}
            JAR_FILE_PATH=./*.jar

      # éªŒè¯æ„å»ºçš„é•œåƒ
      - name: éªŒè¯æ„å»º Docker image
        run: |
          docker images
          #if [ "${{ github.event_name == 'push' || inputs.push_to_docker_registry == true }}" ]; then
          if [ "${{ needs.build-jar-linux.outputs.push_to_docker_registry == 'true' }}" ]; then
            echo "Docker image pushed successfully"
          else
            echo "Docker image built locally only"
          fi
      

      # ============ æ–°å¢ï¼šä¿å­˜å¹¶ä¸Šä¼  Docker é•œåƒ ============
      - name: ä¿å­˜ Docker é•œåƒä¸º tar æ–‡ä»¶
        run: |
          # å–å¾—ç¬¬ä¸€ä¸ª tagï¼ˆé€šå¸¸æ˜¯æœ€ä¸»è¦çš„é‚£ä¸ªï¼‰
          IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n 1)
          echo "æ­£åœ¨ä¿å­˜çš„é•œåƒæ ‡ç­¾: $IMAGE_TAG"

          # ä½¿ç”¨æœ€å®‰å…¨çš„æ–‡ä»¶åç­–ç•¥ï¼šç‰ˆæœ¬å· + æ—¶é—´æˆ³
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAR_FILE_NAME="docker-${{ needs.build-jar-linux.outputs.tag_name }}-${TIMESTAMP}.tar"

          echo "æœ€ç»ˆå®‰å…¨æ–‡ä»¶å: $TAR_FILE_NAME"

          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          if ! docker image inspect "$IMAGE_TAG" >/dev/null 2>&1; then
            echo "âŒ é•œåƒ $IMAGE_TAG ä¸å­˜åœ¨ï¼å½“å‰æœ¬åœ°é•œåƒåˆ—è¡¨ï¼š"
            docker images
            exit 1
          fi

          # ä¿å­˜é•œåƒ
          docker save "$IMAGE_TAG" -o "$TAR_FILE_NAME"

          # è®°å½•ç»™ä¸‹ä¸€æ­¥ä½¿ç”¨
          echo "TAR_FILE_NAME=$TAR_FILE_NAME" >> $GITHUB_ENV

      # åˆ›å»ºä½¿ç”¨è¯´æ˜ Markdown æ–‡ä»¶
      - name: åˆ›å»º Docker ä½¿ç”¨è¯´æ˜æ–‡æ¡£ (README-Docker-Usage.md)
        run: |
          cat <<EOF > README-Docker-Usage.md
          # ${{ github.event.repository.name }} Docker é•œåƒä½¿ç”¨è¯´æ˜

          **å½“å‰é•œåƒç‰ˆæœ¬**ï¼š${{ needs.build-jar-linux.outputs.tag_name}}  
          **æ„å»ºæ—¶é—´**ï¼š$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S') (HKT)  
          **é•œåƒæ ‡ç­¾ç¤ºä¾‹**ï¼šghcr.io/${{ github.repository }}:${{ needs.build-jar-linux.outputs.tag_name }} æˆ– :latest

          è¿™æ˜¯ä¸€ä¸ª**å®Œæ•´çš„ Docker é•œåƒå¯¼å‡ºåŒ…**ï¼ˆ.tar æ–‡ä»¶ï¼‰ï¼ŒåŒ…å« ${{ github.event.repository.name }} åº”ç”¨åŠè¿è¡Œç¯å¢ƒã€‚  
          æ”¯æŒå®Œå…¨ç¦»çº¿éƒ¨ç½²ï¼Œæ— éœ€è”ç½‘æ‹‰å–é•œåƒï¼Œéå¸¸é€‚åˆå†…ç½‘æœåŠ¡å™¨ã€æµ‹è¯•æœºæˆ–å¿«é€Ÿåˆ†å‘ã€‚

          ## 1. å¯¼å…¥é•œåƒ

          åœ¨ä»»ä½•å®‰è£…äº† Docker çš„æœºå™¨ä¸Šï¼Œç›´æ¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

          \`\`\`bash
          # ä½¿ç”¨ workflow ç”Ÿæˆçš„ç²¾ç¡®æ–‡ä»¶åå¯¼å…¥é•œåƒ
          docker load -i $TAR_FILE_NAME

          # æˆåŠŸåä¼šæ˜¾ç¤ºç±»ä¼¼ï¼š
          # Loaded image: ghcr.io/${{ github.repository }}:${{ needs.build-jar-linux.outputs.tag_name }}
          # Loaded image: ghcr.io/${{ github.repository }}:latest
          \`\`\`

          \`\`\`bash
          # æŸ¥çœ‹å·²å¯¼å…¥çš„é•œåƒ
          docker images | grep ${{ github.event.repository.name }}
          \`\`\`

          ## 2. å¯åŠ¨å®¹å™¨ï¼ˆæ¨èæ–¹å¼ï¼‰

          \`\`\`bash
          docker run -d \\
            --name ${{ github.event.repository.name }}\\
            -p 8081:8081 \\
            -v \$(pwd)/${{ github.event.repository.name }}:/app \\           # å¯é€‰ï¼šæŒ‚è½½é…ç½®æ–‡ä»¶ç›®å½•
            --restart unless-stopped \\
            ghcr.io/${{ github.repository }}:${{needs.build-jar-linux.outputs.tag_name }}
          \`\`\`

          - **é»˜è®¤ç«¯å£**ï¼š8081ï¼ˆå¯åœ¨ application-prod.yml ä¸­ä¿®æ”¹ï¼‰  
          - **è®¿é—®åœ°å€**ï¼šhttp://ä½ çš„æœåŠ¡å™¨IP:8081/bgi  
          - **é…ç½®æ–‡ä»¶æŒ‚è½½å»ºè®®**ï¼š  
            åœ¨å½“å‰ç›®å½•åˆ›å»º config æ–‡ä»¶å¤¹ï¼Œå°† application-prod.yml æ”¾å…¥å…¶ä¸­

          ## 3. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

          \`\`\`bash
          # æŸ¥çœ‹å®æ—¶æ—¥å¿—
          docker logs -f ${{ github.event.repository.name }}

          # è¿›å…¥å®¹å™¨å†…éƒ¨ï¼ˆè°ƒè¯•ç”¨ï¼‰
          docker exec -it ${{ github.event.repository.name }} /bin/sh

          # åœæ­¢å¹¶åˆ é™¤å®¹å™¨
          docker stop ${{ github.event.repository.name }} && docker rm ${{ github.event.repository.name }}
          \`\`\`

          ## 4. æ³¨æ„äº‹é¡¹

          - éœ€è¦ Docker 20.10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - å½“å‰é•œåƒå¹³å°ï¼šlinux/amd64ï¼ˆé€‚ç”¨äºå¤§å¤šæ•°æœåŠ¡å™¨å’Œ PCï¼‰
          - å¦‚é‡ç«¯å£å†²çªã€ç½‘ç»œé—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
            - é˜²ç«å¢™è®¾ç½®
            - ç«¯å£æ˜ å°„æ˜¯å¦æ­£ç¡®
            - æ˜¯å¦æœ‰å…¶ä»–ç¨‹åºå ç”¨ 8081 ç«¯å£
          - é—®é¢˜åé¦ˆï¼šæ¬¢è¿åœ¨ GitHub Issues ç•™è¨€

          **ç¥ä½¿ç”¨æ„‰å¿«ï¼**  
          æ–‡æ¡£ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆäºæ„å»º ${{ github.run_id }}
          EOF

          # è°ƒè¯•è¾“å‡ºï¼šç¡®è®¤æ–‡ä»¶åå·²æ­£ç¡®å±•å¼€
          echo "ä½¿ç”¨çš„ TAR_FILE_NAME å€¼ï¼š$TAR_FILE_NAME"
          echo "ç”Ÿæˆçš„ Markdown æ–‡ä»¶å†…å®¹é¢„è§ˆï¼š"
          cat README-Docker-Usage.md      

      - name: ä¸Šä¼  Docker é•œåƒ tar æ–‡ä»¶ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-artifact
          path: |
            ${{ env.TAR_FILE_NAME }}
            README-Docker-Usage.md
          # retention-days: 5 # è®¾ç½®ä¿ç•™å¤©æ•°ä¸º5å¤©


  # å‘å¸ƒåˆ° GitHub Release
  build-and-release:
    runs-on: ubuntu-latest
    needs: [build-jar-linux, build-exe-windows]
    if: ${{ needs.build-jar-linux.outputs.push_to_github_release == 'true' }}
    steps:
      - name: 1. ä¸‹è½½æ‰€æœ‰ artifact
        uses: actions/download-artifact@v4
        with:
          pattern: '*'
          path: artifacts/
          merge-multiple: true

      - name: 2. åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-jar-linux.outputs.tag_name }}
          name: ${{ needs.build-jar-linux.outputs.tag_name }}
          files: |
            artifacts/jars-zip/*.zip
            artifacts/jar-files/**/*.jar
            artifacts/windows-standalone/*.zip
            artifacts/windows-exes/*.exe
          body: |
            **å‘å¸ƒä¿¡æ¯**
            - æ ‡ç­¾ï¼š${{ needs.build-jar-linux.outputs.tag_name }}
            - Java ç‰ˆæœ¬ï¼š${{ needs.build-jar-linux.outputs.java_version }}

            **æ¨èä¸‹è½½**ï¼ˆæ— éœ€å®‰è£… Javaï¼‰
            ${{ github.event.repository.name }}-Windows-${{ needs.build-jar-linux.outputs.tag_name }}.zip  
            â†’ è§£å‹åç›´æ¥åŒå‡» .exe è¿è¡Œ

            å…¶ä»–æ–‡ä»¶ï¼š
            - jars-*.zipï¼šåŸå§‹ JAR åŒ…
            - å•ä¸ª .jar / .exe

            ${{ github.event.inputs.desc }}

            ç³»ç»Ÿè¦æ±‚ï¼šWindows 10/11 x64
          draft: ${{ github.event.inputs.draft || false }}
          prerelease: ${{ github.event.inputs.prerelease || false }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}